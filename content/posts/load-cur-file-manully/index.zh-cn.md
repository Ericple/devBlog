+++
date = '2025-03-13T11:57:18+08:00'
draft = false
title = '从OpenScope到手撕cur光标描述文件'
+++

> 本文将介绍我通过读取cur光标描述文件的二进制数据后，将其通过canvas转换为base64图像再应用到HTML中的cursor属性的过程。
> 对大部分人来说这个操作可能有些奇怪，因为css是可以直接设置cursor: url("xxxx/xxx.cur")来应用cur的，但很遗憾，我这个需求比较特殊，
> 不然也不必如此大费周章了……。不过也好，多熟悉一种格式，也是对自己技术能力的提升。

## 一些可以被跳过的故事

两年前，由于开发需要，我将主力笔记本的系统换到了Ubuntu。当时我在VATSIM模拟飞行联网平台当管制员，所使用的管制软件是来自西班牙的一名程序员的[EuroScope](https://www.euroscope.hu/wp/)。
这款软件很完备，它拥有几乎所有真实管制员所需的功能特性，同时还有强大的插件系统和庞大的插件生态。唯一的缺点是，这个闭源软件只支持Windows操作系统。

我尝试过给开发者发邮件询问他们是否会支持其它平台，得到了否定的答复，当时血气方刚，立志要写一款我们自己的管制软件。于是我开始着手准备自行开发一个管制软件。当时对Electron比较熟悉，并且有一个UniACARS模拟飞行数据监测软件的经验，也是用Electron写的，因此采用了Electron+Vue的方式来写第一版的软件，取名叫[OpenScope](https://github.com/Ericple/openscope-project)，并开源在我的GitHub上。

这个项目得到了小规模的支持，VATSIM区域分部中的许多人给予了我一定的技术帮助，当时在对VATSIM某区域分部的扇区进行大量逆向工作后，实现了部分扇区加载的功能，同时实现了显示vatsim-data.json飞行员数据的功能。但就要开发连接fsd服务器功能的时候，遇到了非技术瓶颈——VATSIM禁止非认证的连飞、管制软件接入VATSIM的fsd连飞服务器。我曾尝试过交涉，也向VATSIM技术部门提交过工单，但最后都杳无音讯，石沉大海。最终这个项目不了了之了。

最近除了维护常规软件以外没有什么事情可做，又意外发现Tauri出了2.0版本，它的跨平台能力甚至比Electron还要好。一开始OpenScope技术选型没选它的原因主要是它还没有出1.0版本，而现在情况发生了变化，于是我就想用Tauri来重新写一写OpenScope，并不断完善它的功能。

## 为什么要手撕cur文件

我在三亚扇中发现了一些EuroScope插件，其中最主要的插件是TopSky.dll，它的存在让扇区在OpenScope和EuroScope的加载中出现了很大的差别，因此我必须考虑对它进行分析逆向，并提供可能所需的API以满足在新环境中重新开发实现其功能的需求。其中一个重要功能，就是TopSky可以修改软件内的光标形式。TopSky插件附带6个cur文件以供使用，但我设计的OpenScope插件系统是插件外置的，而Tauri使用了Vite进行打包，这意味着我无法在css里直接通过绝对路径引用这些cur文件，当然，相对路径也不行。最终，我不得不尝试手撕cur文件，并将它转换为base64图像，进而通过`url()`的方式来实现光标替换。

## cur文件格式解析

> 本文以EuroScope的TopSky插件中提供的`TopSkyCursorCross.cur`为例，通过查看其Binary结构来解析cur文件格式。
> 由于笔者是在Tauri环境下，所以使用tauri提供的方法读取文件。如果你想边看边操作，可以使用其它任意方法读取文件，只要最终可以读取到ArrayBuffer即可。

`.cur`文件是Windows使用的光标文件，它与`.ico`图标采用了一样的结构，但存在一些细微的差异（真的很细微，细微到你可以按完全一致的方式读取这两种文件|笑）。

`.cur`文件可以大致划分为三个区域，分别为：

- 文件头
- 目录
- 图像数据

### 文件头

文件头为6个字节，包含3个数据，每个数据占用2字节。因此在DataView中，我们可以使用`getUint16`方法来读取这些数据。

| 偏移量                                            | bytes | 描述                                                             |
| ------------------------------------------------- | ----- | ---------------------------------------------------------------- |
| 0                                                 | 2     | 保留，值固定为00                                                 |
| 2                                                 | 2     | 文件类型，`1`表示此文件为`.ico`图标，`2`表示此文件为`.cur`光标｜ |
| ｜4｜2｜图像数量，此文件包含的图像数量，一般都是1 |

未完待续
